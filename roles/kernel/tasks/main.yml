---
#- file: path={{ ansible_env.HOME }}/deployed state=directory follow=yes
  #- include: main-debian.yml
  #when: ansible_os_family == 'Debian'
- name: ensure basic packages
  apt: name={{ item }} state=present update_cache=yes
  with_items:
    - git
    - vim-nox
    - zsh
    - screen
    - autoconf
    - automake
    - gcc
    - build-essential
    - libtool
    - libncurses-dev
    - tcpdump
    - hfsprogs
    - elfutils
    - libdw-dev
    - gettext
    - flex
    - bison
    - pkg-config # for ndctl (until asciidoc)
    - libjson-c-dev
    - uuid-dev
    - libudev-dev
    - libkmod-dev
    - asciidoc
    - ethtool
- name: set PATH for bash
  lineinfile: >-
    dest={{home}}/.bash_profile
    create=yes
    state=present
    line='export PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin'
  #    - name: make ~/deployed
  #      file: path={{home}}/deployed owner={{user}} mode=0777 state=directory
  #
- name: create /etc/init/ttyS0.conf
  blockinfile:
    dest: /etc/init/ttyS0.conf
    create: yes
    state: present
    block: |
      start on stopped rc RUNLEVEL=[2345]
      stop on runlevel [!2345]
      respawn
      exec /sbin/getty -8 115200 ttyS0

- name: grub cmd line for subsequent kernel install, including NVMM emulation
  lineinfile:
    dest: /etc/default/grub
    create: no
    state: present
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT'
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="memmap=1G!1G quiet splash console=tty0 console=ttyS0,115200"'
- name: make ~/deployed
  file: path={{home}}/deployed owner={{user}} mode=0777 state=directory
